using UnityEngine;
using System.Collections;

public class DarkInvulnerabilityPower : MonoBehaviour
{
    [Header("Configuración")]
    [Tooltip("Umbral de activación. Para '2 de vida', ponelo en 2.")]
    public float activationHealthThreshold = 2f;

    [Tooltip("Duración del escudo (segundos).")]
    public float invulnerabilityDuration = 3f;

    [Header("Visual del escudo (opcional)")]
    public GameObject shieldVfxPrefab;

    private PlayerHealth playerHealth;
    private PlayerController playerController;

    private bool powerActive = false;

    private Coroutine shieldRoutine;
    private bool isShieldActive = false;

    // Anti-spam: solo dispara cuando cruza hacia <= threshold
    private bool wasAboveThreshold = true;

    private GameObject shieldVfxInstance;

    private void Awake()
    {
        playerHealth = GetComponent<PlayerHealth>();
        playerController = GetComponent<PlayerController>();

        Debug.Log("[DARK INVULNERABILITY] Sistema inicializado (modo escudo 3s a 2 HP)");
    }

    private void Update()
    {
        if (!powerActive) return;
        if (playerHealth == null || playerController == null) return;

        bool isBelowOrEqual = playerHealth.currentHealth <= activationHealthThreshold;

        // Si sube por arriba, rearmamos el trigger
        if (!isBelowOrEqual)
        {
            wasAboveThreshold = true;
            return;
        }

        // Si baja a <= threshold (cruce) activamos
        if (wasAboveThreshold && !isShieldActive)
        {
            wasAboveThreshold = false;
            ActivateShieldForDuration(invulnerabilityDuration);
        }
    }

    private void ActivateShieldForDuration(float duration)
    {
        if (shieldRoutine != null)
            StopCoroutine(shieldRoutine);

        shieldRoutine = StartCoroutine(ShieldCoroutine(duration));
    }

    private IEnumerator ShieldCoroutine(float duration)
    {
        isShieldActive = true;

        // Activar invulnerabilidad
        playerController.isInvulnerable = true;

        // Spawn VFX (si existe)
        SpawnShieldVfx();

        Debug.Log($"[DARK INVULNERABILITY] Escudo ACTIVADO por {duration:0.0}s (HP <= {activationHealthThreshold})");

        yield return new WaitForSeconds(duration);

        // Desactivar invulnerabilidad
        playerController.isInvulnerable = false;

        // Quitar VFX
        DestroyShieldVfx();

        isShieldActive = false;
        shieldRoutine = null;

        Debug.Log("[DARK INVULNERABILITY] Escudo FINALIZADO");
    }

    private void SpawnShieldVfx()
    {
        if (shieldVfxPrefab == null) return;

        DestroyShieldVfx();

        shieldVfxInstance = Instantiate(shieldVfxPrefab, transform);
        shieldVfxInstance.transform.localPosition = Vector3.zero;
        shieldVfxInstance.transform.localRotation = Quaternion.identity;
        shieldVfxInstance.transform.localScale = Vector3.one;
    }

    private void DestroyShieldVfx()
    {
        if (shieldVfxInstance != null)
        {
            Destroy(shieldVfxInstance);
            shieldVfxInstance = null;
        }
    }

    public void ActivatePower()
    {
        powerActive = true;
        wasAboveThreshold = true;
        Debug.Log("[DARK INVULNERABILITY] Power activado");
    }

    public void DeactivatePower()
    {
        powerActive = false;

        if (shieldRoutine != null)
        {
            StopCoroutine(shieldRoutine);
            shieldRoutine = null;
        }

        isShieldActive = false;

        DestroyShieldVfx();

        if (playerController != null)
            playerController.isInvulnerable = false;

        Debug.Log("[DARK INVULNERABILITY] Power desactivado");
    }

    public bool IsProtected()
    {
        return isShieldActive;
    }

    private void OnDisable()
    {
        DeactivatePower();
    }
}
